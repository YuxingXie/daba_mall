<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<ul>
    <!--<li>500,404页面</li>-->
    <!--<li>json返回modelMap改为返回LinkedHashMap</li>-->
    <li>常量配置(分页，图片规格)，邮箱</li>
    <!--<li>分类页分类，不能添加到购物车,排序先limit,skip;</li>-->
    <!--<li>分类页显示星级</li>-->
    <!--<li>产品页，图片不存在应显示404图片，添加到购物车功能失败;</li>-->
    <!--<li>产品页评论显示顺序</li>-->
    <li>产品页刷新页面为何请求两次</li>
    <li>产品页回复 赞不在一行</li>
    <!--<li>购物车清除后总价仍不变bug</li>-->
    <!--<li>整理url中的混乱及规范url命名</li>-->
    <li>产品搜索再优化</li>
    <!--<li>我的订单：时间倒序</li>-->
    <!--<li>我的订单：全部评论完后还显示去评价按钮，状态未显示已评价</li>-->
    <!--<li>我的订单：测试删除订单</li>-->
    <li>我的关注页莫名异常undefined，不影响使用</li>
    <li>图片上传后不能马上显示</li>
    <li>等上线后完善用户修改手机号码功能（免费短信太少不够测试）</li>
    <!--<li>图片自动裁剪</li>-->
    <!--<li>首页，换产品时放大图无效;产品页换图时中图不变</li>-->
    <!--<li>首页，文字重叠</li>-->
    <li>system.out-->log</li>
    <!--<li>一项巨大的工程在等待，集合设计过于分散和小型化是mongodb大忌，因为其不能多表查询，聚合，排序及分组，导致需要多次访问数据库才能得到相关数据，在二期（如果时间允许可集中解决）中将压缩集合数量。</li>-->
</ul>
<div>上线后完善</div>
<ul>
    <li>快捷登录</li>
    <li>个人信息</li>
    <li>在线支付</li>
    <li>产品页评论引导作用域</li>
    <li></li>
</ul>
<div>一些有用的mongodb operations</div>
<pre>
     {
		"prevPrice":{"$exists":true},
		"prevPrice.price":{"$lt":price},
		"$or":[
				{
					"endDate" : null ,
					"beginDate":{"$lt": new Date()}
				},
				{
					"endDate": {"$gt" : new Date()},
					"beginDate":{"$lt": new Date()}
				}
		]
 }
 db.productSeriesPriceHistory.insert({"price":98.98,"productSeriesId":"5595f39fe7c7fa5690325b11"})
db.productSeries.update({"name":"豆腐乳"},{"priceHistoryId":"564598ef6f87bce59c62a7ab"})


db.productSeries.update({"priceHistoryId":"564598ef6f87bce59c62a7ab"},{"priceHistoryId" : "564598ef6f87bce59c62a7ab", "name" : "豆腐乳", "pictures" :[ "statics/assets/temp/products/model2.jpg", "statics/assets/temp/products/model3.jpg", "statics/assets/temp/products/model4.jpg" ], "commonPrice" : 100.36, "evaluateCount" : 101, "description" : "豆腐乳真的很好吃哦~~~", "shelvesDate" : 1435888658381, "brand" : "大坝", "id" : "1111", "productProperties" : [ { "id" : "prop-00002", "propertyName" : "辣度", "productSeries" : null, "propertyValues" :{ "id" : null, "values" : [ "微辣", "中辣", "辣", "麻辣" ], "valueIndex" : null} }, { "id" : "prop-00001", "propertyName" : "包装", "productSeries" : null, "propertyValues" : { "id" : null, "values" : [ "袋装", "散装" ], "valueIndex" : null } } ], "newProduct" : true, "subCategoryId" : "561c648f26dadd00060f4313" })

db.testAuthors.insert({"name" : "chenzhou","email" : "chenzhou1025@126.com"})
author=db.testAuthors.find({name:"chenzhou"})[0]
db.testPosts.insert({"title":"Hello Mongodb DBRef1","authors":[new DBRef('testAuthors',author._id)]})

db.testPosts.insert({"title":"Hello Mongodb DBRef2","authors":[new DBRef('testAuthors',author._id)]})

db.testAuthors.insert({"name" : "xieyuxing","email" : "xieyuxing@126.com"})
author2=db.testAuthors.find({name:"xieyuxing"})[0]
db.testPosts.insert({"title":"Hello Mongodb DBRef3","authors":[new DBRef('testAuthors',author._id),new DBRef('testAuthors',author2._id)]})
   db.productSeriesPrice.find({"prevPrice":{"$exists":true},
   $where":function(){this.prevPrice.price>this.price},
   "$or":[{"endDate" : null,"beginDate":{"$lt": new Date()}},{"endDate": {"$gt" : new Date()},"beginDate":{"$lt": new Date()}}]})


   db.productSeriesPrice.find({"prevPrice":{"$exists":true},"$or":[{"endDate" : null,"beginDate":{"$lt": new Date()}},{"endDate": {"$gt" : new Date()},"beginDate":{"$lt": new Date()}}]})
db.order.find({"_id":ObjectId("56556dc235f0d11a6cb2af61")})
  var category={"categoryName":"鲜活水产"}
db.productCategory.insert({"categoryName":"腌泡食品"})
db.productSubCategory.insert({"categoryId":"561c63c326dadd00060f4312","subCategoryName":"豆制品"})
db.productSeries.update({},{"$set":{"subCategoryId":"561c648f26dadd00060f4313"}})
db.productPropertyValue.insert({"productPropertyId":"5595f892e7c7fa5690325b12","value":"微辣"})
db.productPropertyValue.insert({"productPropertyId":"5595f892e7c7fa5690325b12","value":"中辣"})
db.productPropertyValue.insert({"productPropertyId":"5595f892e7c7fa5690325b12","value":"超辣"})
db.productProperty.insert({"propertyName":"包装","productSeries":"5595f39fe7c7fa5690325b11"})
db.productPropertyValue.insert({"productPropertyId":"562aff8b34e9daf0f8a7aeea","value":"散装"})
db.productPropertyValue.insert({"productPropertyId":"562aff8b34e9daf0f8a7aeea","value":"袋装"})


  db.users.find({"$or":[{ "phone":"13903064816"},{"email":"13903064816"}]})
 db.users.insert({name:"谢宇星",email:"xieyuxing@qq.com",phone:"13903064816",password:"202cb962ac59075b964b07152d234b70"})


db.order.update({"_id":ObjectId("56556dc235f0d11a6cb2af61")},{"$set":{"productSelectedList[0].receiveStatus":"n"}})
db.order.update({"_id":ObjectId("56556dc235f0d11a6cb2af61")},{"$set":{"productSelectedList.$.receiveStatus":"n"}})
db.productEvaluate.find({ "order" : { $java : { "$ref" : "order", "$id" : "com.dabast.entity.Order@14d04ae" } }, "productSeries" : { $java : { "$ref" : "productSeries", "$id" : "com.dabast.entity.ProductSeries@3463f994" } } })
db.productEvaluate.find({ "order" : { "$ref" : "order" , "$id" : "56556dc235f0d11a6cb2af61"} , "productSeries" : { "$ref" : "productSeries" , "$id" : "5653fcef35f0d117289299a3"}})
db.productEvaluate.find({ "order" : { "$id" :  ObjectId("56556dc235f0d11a6cb2af61") , "$ref" : "order"} , "productSeries" : { "$id" :  ObjectId("5653fcef35f0d117289299a3"), "$ref" : "productSeries"}})
db.productEvaluate.find({ "order" : { "$id" :  ObjectId("56556dc235f0d11a6cb2af61") , "$ref" : "order"} })
db.productEvaluate.insert({"content" : "如果我以后吃不到这么好吃的东西，我该怎么办！！！！！！","grade" : 3,"productSeries" : {"$ref" : "productSeries","$id" : ObjectId("5653fcef35f0d117289299a3")}})
db.productEvaluate.insert({"content" : "要不要这么夸张？","parent":{"$ref" : "productEvaluate","$id" : ObjectId("56593aaa35f0d110f856aed7")}})
db.productEvaluate.update({"parent":{"$eq":null}},{"$set":{"type":"evaluate"}},false,true)
db.productEvaluate.update({"parent":{"$ne":null},"content":{"$ne":null}},{"$set":{"type":"reply"}},false,true)
db.productCategory.insert({"categoryName" : "好吃1"})
db.productSubCategory.insert({"subCategoryName" : "乌拉拉","productCategory" : {"$ref" : "productCategory","$id" : ObjectId("564a7f38ad1ab203300d040f")}})
db.productSeries.insert({"name":"卤香干子","pictures":["pic/5653fcef35f0d1172892999d","pic/5653fcef35f0d1172892999f","pic/5653fcef35f0d117289299a1"],"productStore":{"warningAmount" : 30},"newProduct":true,"productSubCategory" :{"$ref":"productSubCategory","$id" : ObjectId("56494922ad1ab21220ebd822")}})
db.productSeriesPrice.remove({"name":{"$ne":null}})
db.productSeries.update({"description":{"$exists":false}},{"$set":{"description":"红烧翅膀我喜欢吃，红烧翅膀我喜欢吃，红烧翅膀我喜欢吃，红烧翅膀我喜欢吃，红烧翅膀我喜欢吃，红烧翅膀我喜欢吃"}})
db.productSeries.remove({"description":{"$exists":false}})
db.order.remove({"_id":ObjectId("56556dc235f0d11a6cb2af61")})
db.account.update({},{"$set":{"bank":"招商银行"}},false,true)
db.account.update({},{"$set":{"bank":new DBRef("bank",ObjectId("566fbb241314abc734cae5ba"))}},false,true)
db.account.update({"_id":ObjectId("565f9c5d35f0d10a745a0853")},{"$set":{"bank":new DBRef("bank",ObjectId("566fbb061314abc734cae5b9"))}},false,true)
db.bank.remove({"_id":ObjectId("566fbaa51314abc734cae5b6")})
db.bank.insert({
    "code": "ICBC",
    "name": "中国工商银行",
    "ico":"20060713191624443.gif",
    "cardSorts":[{"noStart":"427020","cardSort":"","cardName":"中国工商银行VISA学生国际信用卡"},{"noStart":"427030","cardSort":"","cardName":"中国工商银行VISA国际信用卡金卡"},
      {"noStart":"530990","cardSort":"","cardName":"中国工商银行MC国际信用卡普通卡"}
    ,{"noStart":"622230","cardSort":"","cardName":"中国工商银行新版人民币贷记卡普卡"},{"noStart":"622235","cardSort":"","cardName":"中国工商银行新版人民币贷记卡金卡"},
      {"noStart":"622210","cardSort":"","cardName":"中国工商银行新版信用卡(准贷)普卡"}
    ,{"noStart":"622215","cardSort":"","cardName":"中国工商银行新版信用卡(准贷)金卡"},{"noStart":"622200","cardSort":"",
        "cardName":"中国工商银行牡丹灵通卡借记卡"},{"noStart":"955880","cardSort":"","cardName":"中国工商银行原牡丹灵通卡借记卡"}]
  })
  db.order.insert({"orderDate":new Date("2015-09-12"),"user":new DBRef("users",ObjectId("55b1e75a845c14e957d5331c"))})
  db.notify.insert({
  "content" : "您的订单 5677769eb88c13fe66b79389 因超过7天未使用，系统已自动删除。",
  "date" : ISODate("2015-12-21T03:48:50.097Z"),
  "read" : false,
  "title" : "系统通知",
  "toUser" : new DBRef("users",ObjectId("55b1e75a845c14e957d5331c"))
})
    //聚合的一些操作
1.投射：投射可以理解为从文档中取出哪些属性，_id是自动被包含的
db.productSeries.aggregate({"$project":{"name":1}})

 查询结果类似于
{ "_id" : ObjectId("56739c8935f0d1141c4b2419"), "name" : "沩山香干" }
{ "_id" : ObjectId("56739f5435f0d11750c691de"), "name" : "含笑半步癫" }

投射的属性能否取别名，于是我用下面的语句查询结果报错
db.productSeries.aggregate({"$project":{"name":"allias"}})//exception
这才是取别名正解：db.productSeries.aggregate({"$project":{"allias":"$name"}})//ok


2.分组:
db.productSeries.aggregate({"$group":{"_id":"$brand","count":{"$sum":1}}})
解释:用brand属性对文档分组，用$符号应用的字段设置为_id,文档中每个分组的每条记录出现一次则count+1(当然也可以+2)
结果：
{ "_id" : "3", "count" : 1 }
{ "_id" : "daba", "count" : 1 }
{ "_id" : "大坝", "count" : 3 }

3.投射与分组结合使用
三个例子
db.productSeries.aggregate({"$project":{"name":1,"brand":1}},{"$group":{"_id":"$brand","count":{"$sum":1}}})
结果：
{ "_id" : "3", "count" : 1 }
{ "_id" : "daba", "count" : 1 }
{ "_id" : "大坝", "count" : 3 }
db.productSeries.aggregate({"$project":{"name":1}},{"$group":{"_id":"$brand","count":{"$sum":1}}})
结果：{ "_id" : null, "count" : 5 }
db.productSeries.aggregate({{"$group":{"_id":"$brand","count":{"$sum":1}}},{"$project":{"name":1,"brand":1}})
 结果：查询卡住了
 结论：投射与分组组合使用的话，投射要放前面，分组是以投射的结果为前提的，如果投射的字段中没有分组的字段,这三个例子中实际上只有第一个有意义

4.排序
 简单的排序
 先看看这个例子db.productSeries.find({},{"$sort":{"brand":-1}})，它是错误的。本人测试，排序似乎无法用find函数查询
 db.productSeries.aggregate({"$project":{"brand":1}},{"$sort":{"brand":-1}})
 结果：
 { "_id" : ObjectId("56739c8935f0d1141c4b2419"), "brand" : "大坝" }
{ "_id" : ObjectId("56739f5435f0d11750c691de"), "brand" : "大坝" }
{ "_id" : ObjectId("5673b60435f0d11750c691ed"), "brand" : "大坝" }
{ "_id" : ObjectId("5679fe7635f0d101686906e7"), "brand" : "daba" }
{ "_id" : ObjectId("5679fe9535f0d101686906ed"), "brand" : "3" }
结论：排序也必须先经过投射，用aggregate函数查询

5.投射分组排序结合使用
结合三者使用看似很复杂，实际并非很难，不过是先投射，再分组，再排序，分组用投射的结果，排序用分组的结果而已
db.productSeries.aggregate({"$project":{"name":1,"brand":1}},{"$group":{"_id":"$brand","count":{"$sum":1}}},{"$sort":{"count":-1}})
结果：
{ "_id" : "大坝", "count" : 3 }
{ "_id" : "3", "count" : 1 }
{ "_id" : "daba", "count" : 1 }

 6.查询后再进行聚合可以吗？
 下面的语句是报错的
 db.productSeries.find({}).aggregate({"$project":{"name":1,"brand":1}})//TypeError: Object DBQuery: test.productSeries -> { } has no method 'aggregate'
 这样就可以：
 db.productSeries.aggregate({"$match":{}},{"$project":{"name":1,"brand":1}})
 结论：查询条件在aggregate函数中用管道操作符$match中定义

 7.可以不先投射直接分组吗?当然可以，前面就有现成的示例，所以投射不是聚合的必要前提
 db.productSeries.aggregate({"$group":{"_id":"$brand","count":{"$sum":1}}})


 //MapReduce示例



map=function(){
for(var key in this){
    emit(key,{count:1});
}
}
 说明：map函数重要的是理解this和emit函数的参数。this是mongodb循环某个集合的所有文档时的某一个文档；key是该文档的一个属性；
    emit函数理解为：把一个数据用key-value的方式发送到某个集合类型的数据中（可以类比java中的hashMap）。
      其中第一个参数最终会成为输出集合的_id
极其重要的忠告：我用this对象中的某个ObjectId对象作为emit方法的第一个参数，结果结果完全不正确。即便使用了toString方法转换都不行，
所以这里的key不要和ObjectId对象有什么关系，虽然理论上并没有说不能这样。
reduce=function(key,emits){
total=0;
for(var i in emits){
total+=emits[i].count;
}
return {"count":total};//return必须是单条记录不可是个集合
}
r1=reduce("x",[{count:1,id:1},{count:1,id:2},{count:1,id:3}])
结果：{ "count" : 3 }
r2=reduce("x",[{count:1,id:4}])
结果：{ "count" : 1 }
reduce("x",[r1,r2])
结果：{ "count" : 4 }
mr=db.runCommand({"mapreduce":"productSeries","map":map,"reduce":reduce,"out":"outS"})
 结果：
{
        "result" : "outS",
        "timeMillis" : 61,
        "counts" : {
                "input" : 5,
                "emit" : 49,
                "reduce" : 10,
                "output" : 10
        },
        "ok" : 1
}
最后
> db.outS.find()
{ "_id" : "_class", "value" : { "count" : 5 } }
{ "_id" : "_id", "value" : { "count" : 5 } }
{ "_id" : "brand", "value" : { "count" : 5 } }
{ "_id" : "description", "value" : { "count" : 5 } }
{ "_id" : "name", "value" : { "count" : 5 } }
{ "_id" : "newProduct", "value" : { "count" : 5 } }
{ "_id" : "pictures", "value" : { "count" : 4 } }
{ "_id" : "productStore", "value" : { "count" : 5 } }
{ "_id" : "productSubCategory", "value" : { "count" : 5 } }
{ "_id" : "shelvesDate", "value" : { "count" : 5 } }

</pre>
</body>
</html>